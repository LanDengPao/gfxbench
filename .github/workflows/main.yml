name: Build Android Vulkan APK

on:
  workflow_dispatch:

env:
  CONFIG: 'Release'
  WORKSPACE: ${{ github.workspace }}

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android Environment
        run: |
          echo "SDKP=/tmp/android_sdk" >> $GITHUB_ENV
          echo "ANDROID_NDK=$HOME/android-sdk/ndk/28.0.12674087" >> $GITHUB_ENV
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "NG_CMAKE_TOOLCHAIN_FILE=$HOME/android-sdk/ndk/28.0.12674087/build/cmake/android.toolchain.cmake" >> $GITHUB_ENV
          echo "CONFIG=Release" >> $GITHUB_ENV
          echo "WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          echo "BUNDLE_DATA=True" >> $GITHUB_ENV
          echo "MAKEFLAGS=-j$(nproc)" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/tmp/android_sdk/" >> $GITHUB_ENV
          echo "PLATFORM=android" >> $GITHUB_ENV
          echo "PLATFORMS=android-arm64-v8a" >> $GITHUB_ENV
          echo "CUDAToolkit_ROOT=/usr/local/cuda" >> $GITHUB_ENV

      - name: Install Android Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y \
            cmake build-essential ninja-build \
            curl ca-certificates unzip openjdk-17-jdk swig python-is-python3
          # Force update-alternatives to use Java 17 if for any reason Java 11 remains default.
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java || true
          sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac || true
          java -version

      - name: Install Android SDK/NDK
        run: |
          ./doc/android_deps.sh

      - name: Install CUDA
        uses: Jimver/cuda-toolkit@v0.2.15
        with:
          cuda: 11.8.0
          sub-packages: '["cudart", "nvcc"]'
          method: network

      - name: Verify CUDA Toolkit
        shell: bash
        run: |
          echo "CUDA_PATH=$CUDA_PATH"
          which nvcc || echo "nvcc not in PATH (expected for minimal)." || true
          ls -1 "$CUDA_PATH" | head -n 20 || true

      - name: Build Android Vulkan APK
        run: |
          ./scripts/build-multiarch-apk.sh

          
      - name: Upload Android APK
        if: ${{ matrix.platform == 'android' && (inputs.platform == 'android' || inputs.platform == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: |
            **/*.apk
          retention-days: 90
          
